<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./styles/style.css" />
  <script src="https://kit.fontawesome.com/eebdb6e4f5.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>


  <title>Document</title>
</head>

<body class="Dashboard">
  <nav class="menu-nav">
    <div class="logo-nav-lateral">
      <a href="./index.html"><img src="./docs/Logo-Monarex.png" alt="logo" /></a>
      <div class="menu-container">
        <ul>
          <li>
            <a href="./dashMes.html"><i class="fa-solid fa-table fa-lg"></i>Mensal</a>
          </li>
          <li>
            <a href="#"><i class="fa-solid fa-table-columns fa-lg"></i>Diário</a>
          </li>
          <li>
            <a href="./telaFunc.html"><i class="fa-solid fa-users fa-lg"></i>Funcionários</a>
          </li>
          <li>
            <a href="./sensores.html"><i class="fa-solid fa-circle fa-lg"></i>Sensores</a>
          </li>
          <li>
            <a href="https://monarex.atlassian.net/servicedesk/customer/portal/1/group/-1"><i class="fa-solid fa-angles-up"></i>Central de Atendimento</a>
          </li>
          <li id="liSuporte">
          </li>
           <li id="liJira">
          </li>
        </ul>
      </div>
    </div>

    <div class="sair-nav">
      <a onclick="sair()">Sair</a>
      <img src="./docs/exit-icon.png" alt="sair" />
    </div>
  </nav>

  <div id class="cabecalho-mensal" style="margin-left: 245px; margin-right: 20px; margin-top: 5px;">
    <h1>Dashboard <span>Diário</span></h1>
    <div class="imagem-cabecalho">
      <i class="fa-solid fa-bell"></i>
      <a href="./perf.html"><img src="./docs/fernando-brandao-icon.jpg" alt="" /></a>
    </div>
  </div>

  <!--Vazamento-->
  <div class="alerta_caixa oculto" id="alertaCaixa"></div>
  



  <div class="container-dashboard-content">



    <section class="section-graphic">
      <div class="container-row">
        <div class="container-status-sensor">
          <div class="flex-row-box">
            <img src="./docs/Vector (3).png" alt="">
            <p>Status</p>
          </div>


          <div id="statusCor" class="flex-row-box-status">

            <button onclick="vazar()">
              <p id="statusSensor"></p>
            </button>
          </div>

        </div>

        <div class="container-leak-camara">
          <div class="flex-row-box">
            <p> Câmaras com Vazamentos </p>
          </div>
          <div class="box-style-leak" id="lista_vazamento"></div>
        </div>


      </div>
      <div class="container-camara">
        <div class="camara-text">
          <p> Selecione a Câmara </p>
          <p> Período </p>
          <p> Sensor </p>
        </div>
        <div class="container-camara-selects">
          <select name="#" id="selectCamara" class="camara-select">
            <option value="#" disabled> Selecione </option>
            <option value="1" selected> Câmara 01</option>
            <option value="2">Câmara 02</option>
          </select>

          <select name="#" id="selectTempo" class="temp-select">
            <option value="#" disabled selected> Selecione o Horário</option>
            <option value="0">Atual</option>
            <option value="24-horas">Últimas 24 horas</option>
            <option value="12-horas">Últimas 12 horas</option>
            <option value="6-horas">Últimas 6 horas</option>
            <option value="3-horas">Últimas 3 horas</option>
          </select>

          <select name="#" id="selectSensor" class="sensor-select">
            <option value="#" disabled selected> Selecione </option>
            <option value="sensor-01">Sensor 01</option>
            <option value="sensor-02">Sensor 02</option>
            <option value="sensor-03">Sensor 03</option>
          </select>
        </div>
      </div>
      <section class="elementos-01">
        <div class="chart-container">
          <div class="chart-titulo">
            <i class="fa-solid fa-hourglass-half"></i>
            <p>Horários de Picos</p>
          </div>
          <canvas id="chart-horario"></canvas>
        </div>

      </section>
    </section>

    <section class="section-diaria">

      <div id="container-ppm-diaria" class="ppm-container">
        <div class="titulo-ppm">
          <i class="fa-solid fa-atom"></i>
          <p>PPM</p>
        </div>
        <div class="card">
          <div class="card-ppm">
            <p><span id="kpiMinimo" class="saida-ppm"></span></p>
            <p>Mínimo</p>

          </div>
          <div class="card-ppm">
            <p><span id="kpiMedio" class="saida-ppm"></span></p>
            <p>Média</p>

          </div>
          <div class="card-ppm">
            <p><span id="kpiMaximo" class="saida-ppm"></span></p>
            <p>Máximo</p>

          </div>
        </div>
      </div>

      <div class="tabela">
    <table class="tabela-funcionarios">
      <thead>
        <tr>
          <th>PPM</th>
          <th>Sensor ID</th> 
          <th>Câmara ID</th> 
          <th>Tempo de Leitura</th>
        </tr>
      </thead>
      <tbody id="historicoSensorBody"> 
        <tr>
          <td colspan="4">Carregando histórico...</td>
        </tr>
      </tbody>
    </table>
      </div>




  </div>
  </section>
  </div>


</body>

</html>


<script>

  var proximaAtualizacaoPPM;
  var proximaAtualizacaoKPI;


  const kpiMaximo = document.getElementById('kpiMaximo');
  const kpiMedio = document.getElementById('kpiMedio');
  const kpiMinimo = document.getElementById('kpiMinimo');
  const statusSensor = document.getElementById('statusSensor');
  const lista_vazamento = document.getElementById('lista_vazamento');
  const cth = document.getElementById("chart-horario");
  const alertaCaixa = document.getElementById('alertaCaixa');
  var graficoPPM;


  window.onload = function () {
    const permisaoSuporte = sessionStorage.getItem('SUPORTE');
      const liSuporte = document.getElementById('liSuporte');

      if(permisaoSuporte == 'true'){

      liSuporte.innerHTML = `<a href="./bobIA.html"><i class="fa-solid fa-headset"></i>Suporte</a>`
    }

    iniciarKpi;
    renderizarGraficoPPM();
    iniciarKpi();
    renderizarGraficoPPM([], []);
    historicoSensor();
    const selectCamara = document.getElementById('selectCamara');
    const selectTempo = document.getElementById('selectTempo');


    if (selectCamara && selectCamara.value && selectCamara.value !== '#') {
      iniciarDashboardEUpdates();


    }

    if (selectCamara) selectCamara.addEventListener('change', iniciarDashboardEUpdates);
    if (selectTempo) selectTempo.addEventListener('change', iniciarDashboardEUpdates);
  };


  function iniciarKpi() {

    //KPI PPM MÁXIMO

    fetch('/kpi/maximo_diario/', {
      method: 'POST',
      headers: {
        'Content-type': 'application/json',
      },
      body: JSON.stringify({
        idEmpresaServer: sessionStorage.ID_EMPRESA
      })
    }).then(function (response) {
      console.log('entrei no then do fetch maximo');

      if (response.ok) {

        response.json().then((json) => {
          console.log(json)
          if (json && json.length > 0 && json[0].max_sensor != undefined) {
            kpiMaximo.innerHTML = json[0].max_sensor;
            kpiMedio.innerHTML = json[0].media_sensor;
            kpiMinimo.innerHTML = json[0].min_sensor;

            const status = verificarStatus(Number(json[0].max_sensor));

            statusSensor.innerHTML = `<img src="./docs/Vector (4).png" alt=""> ${status}`;
          } else {
            kpiMaximo.innerHTML = 'Sem dados'
            kpiMedio.innerHTML = 'Sem dados'
            kpiMinimo.innerHTML = 'Sem dados'
            statusSensor.innerHTML = 'Erro'
          }
        });
      }
    })

  }

  function mostrarAlerta() {
    fetch('/kpi/alerta/', {
      method: 'POST',
      headers: {
        'Content-type': 'application/json',
      },
      body: JSON.stringify({
        idEmpresaServer: sessionStorage.ID_EMPRESA
      })
    }).then(response => {
      console.log('entrei no then do fetch alerta');

      if (response.ok) {
        response.json().then((json) => {
          console.log(json)
          if (json && json.length > 0 && json[0].sensor != undefined) {

            var sensor = json[0].sensor;
            var camara = json[0].camara;
            console.log('DADOS DOS SENSORES', sensor, camara)

            exibirAlerta(sensor, camara)

          }
        })
      }
    })
    
  }

  function exibirAlerta(sensor, camara) {
    if (!alertaCaixa) {
      console.error("Erro: Elemento 'alertaCaixa' não encontrado no DOM.");
      return;
    }

    // Injeta o conteúdo HTML
    alertaCaixa.innerHTML = `
<button onclick="fecharVazamento()" class="botao_fechar" id="fecharBotao">×</button>
<div class="alerta_icon">
    <img class="imagem_alerta" src="./docs/imagens-saida.png" alt="alerta de imagem">
</div>
<div class="alerta_titulo">ALERTA DE VAZAMENTO</div>
<div class="alerta_texto">
    Sensor ${sensor} reportou dados na Câmara ${camara}.
</div>
<button class="alerta_botao" id="alertaBotao">
    <a href="./dashMes.html">VER DETALHES 
 <img src="./docs/iconamoon_enter.png" alt="ver detalhes">
    </a>
</button>`;
// 1. Remove a classe que oculta o elemento
    alertaCaixa.classList.remove('oculto');
    // 2. Garante que o display não está 'none'
    alertaCaixa.style.display = 'block'; // Ou 'flex', dependendo do seu CSS
    // 3. Adiciona a classe de estilo/animação
    alertaCaixa.classList.add('alerta-ativo');
  }

  function fecharVazamento() {
    if (alertaCaixa) {
        alertaCaixa.classList.add('oculto');
        alertaCaixa.style.display = 'none'; // Se você usar 'block' ou 'flex' acima, use 'none' aqui.
        alertaCaixa.classList.remove('alerta-ativo');
        alertaCaixa.innerHTML = '';
    }
  }



  function  q(valorMaximo) { // Renomeei para maior clareza
    if (valorMaximo >= 15) {
      mostrarAlerta();
      statusCor.style.backgroundColor = "#B30000";
      return `CRITICO`; // Deve retornar apenas a string

    } else if (valorMaximo >= 10) {
      statusCor.style.backgroundColor = "#ffaa00";
      return `ALERTA`; // Deve retornar apenas a string
    } else {
      fecharVazamento();
      statusCor.style.backgroundColor = "#003d02";
      return `NORMAL`; // Deve retornar apenas a string
    }
  }



  function iniciarDashboardEUpdates() {

    if (proximaAtualizacaoPPM !== undefined) {
      clearTimeout(proximaAtualizacaoPPM);
    }
    if (proximaAtualizacaoKPI !== undefined) {
      clearTimeout(proximaAtualizacaoKPI);
    }

    const selectCamara = document.getElementById('selectCamara');
    const idCamara = selectCamara ? selectCamara.value : idCamara;
    if (idCamara && idCamara !== '#') {
      buscarDadosPPM(idCamara);
    }

    atualizarKPIsVazamentosLoop(idCamara);
  }

  function buscarDadosPPM(idCamara) {
    if (proximaAtualizacaoPPM != undefined) {
      clearTimeout(proximaAtualizacaoPPM);
    }

    const endpoint = `/camara/medidas-ppm/${idCamara}`;

    fetch(endpoint)
      .then(response => {
        if (!response.ok) {
          console.error('Falha na API de PPM. Status: ', response.status);
          throw new Error('Falha ao buscar dados do PPM.');
        }
        return response.status !== 204 ? response.json() : [];
      })
      .then(dadosMedicao => {
        console.log("Dados de PPM recebidos:", dadosMedicao);

        const labels = [];
        const valores = [];

        for (let i = 0; i < dadosMedicao.length; i++) {
          const item = dadosMedicao[i];
          labels.push(item.momento_grafico);
          valores.push(item.sensor_analogico);
        }

        renderizarGraficoPPM(labels, valores);

        proximaAtualizacaoPPM = setTimeout(() => buscarDadosPPM(idCamara), 5000);

      })
      .catch(error => {
        console.error('Erro ao buscar dados de PPM:', error);
        proximaAtualizacaoPPM = setTimeout(() => buscarDadosPPM(idCamara), 5000);
      });
  }


  function renderizarGraficoPPM(labels, valores) {

    const dataDinamica = {
      labels: labels,
      datasets: [{
        label: "PPM (Partes por Milhão)",
        data: valores,
        hoverOffset: 4,
        fill: true,
        borderColor: "#4CAF50",
        backgroundColor: "#4CAF5050",
        pointRadius: 3,
        tension: 0.4,
      }],
    };

    const configDinamica = {
      type: "line",
      data: dataDinamica,
      options: {
        layout: { padding: { bottom: 9 } },
        plugins: {
          annotation: {
            annotations: {
              linhaLimite: {
                type: 'line',
                yMin: 20,
                yMax: 20,
                borderColor: 'red',
                borderWidth: 2
              }
            }
          },
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              font: { size: 11 }
            }
          }
        },
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            min: 0,
            max: 30,
            ticks: { font: { size: 7 } },
          },
          x: {
            ticks: { font: { size: 7 } },
          },
        },
      },
    };

    if (graficoPPM) {
      graficoPPM.data.labels = labels;
      graficoPPM.data.datasets[0].data = valores;
      graficoPPM.update();
    } else {
      graficoPPM = new Chart(cth, configDinamica);
    }
  }


  function atualizarKPIsVazamentosLoop(idCamara) {
    if (proximaAtualizacaoKPI !== undefined) {
      clearTimeout(proximaAtualizacaoKPI);
    }

    iniciarKpi(idCamara);
    iniciar_vazamentos();

    proximaAtualizacaoKPI = setTimeout(() => atualizarKPIsVazamentosLoop(idCamara), 10000);
  }




  function iniciar_vazamentos() {
    const idEmpresa = sessionStorage.ID_EMPRESA;
    const endpoint = `/camara/vazamento/${idEmpresa}`;

    fetch(endpoint, {
      method: 'GET'
    })
      .then(response => {
        if (!response.ok) {
          console.error('Falha na API de Vazamentos. Status: ', response.status);
          throw new Error('Falha ao buscar dados do vazamento. Resposta do servidor indisponivel')
        }
        return response.json();
      })
      .then(lista_camaras => {
        console.log('Lista de vazamentos recebida: ', lista_camaras);

        if (lista_camaras && lista_camaras.length > 0) {
          exibir_vazamento(lista_camaras);
        } else {
          lista_vazamento.innerHTML = "<p> Nenhuma câmara com vazamento detectado. </p>"
        }
      })
      .catch(error => {
        console.error('Erro ao iniciar Vazamentos: ', error);
        lista_vazamento.innerHTML = "<p> Erro ao carregar lista de vazamentos </p>"
      })
  }

  function exibir_vazamento(lista_camaras) {
    lista_vazamento.innerHTML = "";

    lista_camaras.forEach(camara => {
      const card = `
            <div class="${camara.classe}">
                <p> ${camara.nome} </p>
            </div>
        `
      lista_vazamento.innerHTML += card;
    });
  }


function historicoSensor() {
    fetch('/kpi/historico-sensor/', {
        method: 'POST',
        headers: {
            'Content-type': 'application/json',
        },
        body: JSON.stringify({
            idEmpresaServer: sessionStorage.ID_EMPRESA
        })
    }).then(function (response) {
        console.log('Entrei no fetch de Histórico do Sensor'); 
        if (response.ok) {

            var tbody = document.getElementById("historicoSensorBody"); 
            tbody.innerHTML = "";

            response.json().then(function (leituras) {
                if (leituras.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">Nenhuma leitura encontrada.</td></tr>';
                    return;
                }
                for (let i = 0; i < leituras.length; i++) {
                    var leitura = leituras[i];
                    var tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td> ${leitura.ppm} </td> 
                        <td> ${leitura.id_sensor} </td>
                        <td> ${leitura.numero_camara} </td>
                        <td> ${leitura.tempo_leitura} </td>
                    `;

                    tbody.appendChild(tr);
                }
            });
        } else {
             var tbody = document.getElementById("historicoSensorBody");
             tbody.innerHTML = '<tr><td colspan="4">Erro ao carregar o histórico.</td></tr>';
        }
    })
}


function sair(){
          
          sessionStorage.clear();
          window.location.href ='../index.html'
        }
</script>