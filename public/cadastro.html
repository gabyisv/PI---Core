<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro - Monarex</title>
    <link rel="stylesheet" href="./styles/style.css" />
    <script src="monarex.js"></script>
  </head>
  <body>
    <div class="body-container">
      <div class="left">
        <div class="container-left">
          <div class="image-left">
            <img src="./docs/logo.png" alt="" class="logo" />
            <h1>Sensores de Amônia</h1>
          </div>
        </div>
      </div>

      <div class="right">
        <div
          style="display: none"
          id="cadastro_supervisor"
          class="container-right"
        >
          <h1>CADASTRO</h1>

          <div class="cadastro-input-container">
            <div class="container-nome container">
              <label for=""> Nome</label>
              <input
                type="text"
                placeholder="Digite o seu nome"
                id="nome_input"
              />
            </div>

            <div class="container-nome container">
              <label for=""> Sobrenome</label>
              <input
                type="text"
                placeholder="Digite o seu nome"
                id="input_sobrenome"
              />
            </div>

            <div class="container-email container">
              <label for=""> E-mail </label>
              <input
                type="text"
                placeholder="Digite o seu E-mail"
                id="email_input"
              />
              <div id="msg_erro_email" class="msg_erro"></div>
            </div>

            <div class="container-senha container">
              <label for=""> Senha </label>
              <input
                type="password"
                placeholder="Crie uma senha forte"
                id="senha_input"
                oninput="validarSenha()"
              />
              <div id="msg_erro_senha" class="msg_erro"></div>
              <p class="text-pass">
                Na senha tem que haver ao menos 1 caracter especial, 1 letra
                maiúscula e 1 número
              </p>
            </div>

            <div class="container-senha container">
              <label for=""> Confirme a sua Senha </label>
              <input
                type="password"
                placeholder="Repita a senha criada"
                id="confirmacao_senha_input"
                oninput="validarSenha()"
              />
              <div id="msg_erro_senha" class="msg_erro"></div>
            </div>

            <button class="button-cadastro button" onclick="cadastrar()">
              Cadastrar
            </button>
          </div>

          <div id="mensagem_erro"></div>
          <div id="cadastro-empresa" class="cadastro-text-container">
            <p>Já é cadastrado? <a href="login.html"> Logue Aqui </a></p>
          </div>
        </div>

        <div
          id="cadastro_empresa"
          class="cadastro-input-container"
          style="display: flex"
        >
          <h1>CADASTRO DA EMPRESA</h1>

          <div class="container-cnpj container">
            <label for=""> Razão Social </label>
            <input
              type="text"
              placeholder="Digite a razão social da empresa"
              id="input_razaoEmpresa"
              maxlength="14"
              oninput="cnpj()"
            />
          </div>

          <div class="container-cnpj container">
            <label for=""> CNPJ </label>
            <input
              type="text"
              placeholder="Digite o CNPJ da empresa"
              id="input_cnpj"
              maxlength="14"
              oninput="cnpj()"
            />
          </div>

          <button class="button-cadastro button" onclick="testeStorage()">
            Cadastrar
          </button>
        </div>
      </div>
    </div>
  </body>
</html>

<script>


  function numeroSenha(senhaVar) {
    var numeros = '1234567890' 

    for (var i = 0; i < senhaVar.length; i++) {
      if(numeros.includes(senhaVar[i])) {
        return true;
      }
    }
    return false;
  }




  function caracterEspecial(senhaVar) {
    var caracter = '!@#$%&*'

    for(var i = 0; i < senhaVar.length; i++) {
      if(caracter.includes(senhaVar[i])) {
        return true;
      }
    }
    return false;
  }




  function validarSenha() {
    var senhaVar = senha_input.value;
    var confirmacaoSenhaVar = confirmacao_senha_input.value;

    if (senhaVar == '') {
      msg_erro_senha.innerHTML = `A senha deve ser preenchida`
      return false;
    }

    if (senhaVar.length < 8 ) {
      msg_erro_senha.innerHTML = `A senha precisa conter no mínimo 8 caracteres`
      return false;
    }

    if(!numeroSenha(senhaVar)) {
      msg_erro_senha.innerHTML = `A senha precisa ter pelo menos um número`
      return false;
    }

    if(!caracterEspecial(senhaVar)) {
      msg_erro_senha.innerHTML = `A senha precisa ter ao menos um caracter especial`
      return false;
    }

    if(senhaVar == senhaVar.toLowerCase()) {
      msg_erro_senha.innerHTML = `A senha precisa ter ao menos uma letra maiuscula`
      return false;
    }

    if (senhaVar != confirmacaoSenhaVar) {
      msg_erro_senha.innerHTML = `As senhas devem ser iguais`
      return false;
    }

    msg_erro_senha.innerHTML = ''
    return true;
  }



  function validarEmail() { 
    var emailVar = email_input.value;
  
    if (emailVar == "") {
        msg_erro_email.innerHTML = `O e-mail deve ser preenchido.`;
        return false;
    }

    if (!emailVar.includes('@')) {
        msg_erro_email.innerHTML = `O e-mail precisa ter um @ para ser cadastrado.`;
        return false;
    } 
    
    if (!emailVar.endsWith('.com')) {
        msg_erro_email.innerHTML = `É necessário que o e-mail termine com ".com" para ser cadastrado`;
        return false;
    }
    
    msg_erro_email.innerHTML = '';
    return true; 
}
  

  // Array para armazenar empresas cadastradas para validação de código de ativação
  /// let listaEmpresasCadastradas = [];
  sessionStorage.CNPJ = "";
  sessionStorage.RAZAO = "";


   function cnpj() {
     var cnpj = input_cnpj.value
     if(cnpj.length == 2){
             input_cnpj.value += '.'
     } 
      if(cnpj.length == 6){
             input_cnpj.value += '.'
     } 
     if(cnpj.length == 10){
             input_cnpj.value += '/'
     } 
     if(cnpj.length == 15){
             input_cnpj.value += '-'
     } 
 }

  function testeStorage() {
    sessionStorage.RAZAO = input_razaoEmpresa.value;
    sessionStorage.CNPJ = input_cnpj.value;
    cadastro_supervisor.style.display = "flex";
    cadastro_empresa.style.display = "none";
  }

  function cadastrar() {
    // aguardar();

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo
    var nomeVar = nome_input.value;
    var sobrenomeVar = input_sobrenome.value;
     var emailVar = email_input.value;
    var senhaVar = senha_input.value;
    

    if (nomeVar == "") {
        mensagem_erro.innerHTML = "O campo Nome não pode estar vazio.";
        return false; 
    }


    if (!validarEmail()) { 
        mensagem_erro.innerHTML = "Verifique o formato do e-mail.";
        return false; 
    }


    if (!validarSenha()) {
        mensagem_erro.innerHTML = "Verifique os requisitos da senha.";
        return false; 
    }
    



    // Enviando o valor da nova input
    fetch("/usuarios/cadastrar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        // crie um atributo que recebe o valor recuperado aqui
        // Agora vá para o arquivo routes/usuario.js
        nomeServer: nomeVar,
        sobrenomeServer: sobrenomeVar,
        emailServer: emailVar,
        senhaServer: senhaVar,
        cnpjServer: sessionStorage.CNPJ,
        razaoServer: sessionStorage.RAZAO
      }),
    })
      .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
          //   cardErro.style.display = "block";

          mensagem_erro.innerHTML =
            "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

          setTimeout(() => {
            window.location = "login.html";
          });

          limparFormulario();
          //   finalizarAguardar();
        } else {
          throw "Houve um erro ao tentar realizar o cadastro!";
        }
      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
        // finalizarAguardar();
      });

    return false;
  }

  // async function cadastrarEmpresas() {
  //   var razaoVar = input_razaoEmpresa.value;
  //   var cnpjVar = input_cnpj.value;

  //   cadastro_supervisor.style.display = "flex";
  //   cadastro_empresa.style.display = "none";
    // aguardar();

    //Recupere o valor da nova input pelo nome do id
    // Agora vá para o método fetch logo abaixo

    // Verificando se há algum campo em branco
  //   if (cnpjVar == "" || razaoVar == "") {
  //     //   cardErro.style.display = "block";
  //     mensagem_erro.innerHTML =
  //       "(Mensagem de erro para todos os campos em branco)";

  //     //   finalizarAguardar();
  //     return false;
  //   } else {
  //     setInterval(1000);
  //   }

  //   // Enviando o valor da nova input
  //   fetch("/usuarios/cadastrarEmpresas", {
  //     method: "POST",
  //     headers: {
  //       "Content-Type": "application/json",
  //     },
  //     body: JSON.stringify({
  //       // crie um atributo que recebe o valor recuperado aqui
  //       // Agora vá para o arquivo routes/usuario.js
  //       cnpjServer: cnpjVar,
  //       razaoServer: razaoVar,
  //     }),
  //   })
  //     .then(function (resposta) {
  //       console.log("resposta: ", resposta);

  //       if (resposta.ok) {
  //         //   cardErro.style.display = "block";

  //         mensagem_erro.innerHTML =
  //           "Cadastro realizado com sucesso! Redirecionando para tela de Login...";

  //         limparFormulario();
  //         //   finalizarAguardar();
  //       } else {
  //         throw "Houve um erro ao tentar realizar o cadastro!";
  //       }
  //     })
  //     .catch(function (resposta) {
  //       console.log(`#ERRO: ${resposta}`);
  //       // finalizarAguardar();
  //     });

  //   return false;
  // }

  //   function sumirMensagem() {
  //     cardErro.style.display = "none";
  //   }
</script>
