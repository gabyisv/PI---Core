<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles/style.css" />
    <script
      src="https://kit.fontawesome.com/eebdb6e4f5.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
    
    <title>Document</title>
  </head>
  <body class="Dashboard">
    
    <nav class="menu-nav">
      <div class="logo-nav-lateral">
        <a href="./index.html"><img src="./docs/Logo-Monarex.png" alt="logo" /></a>
        <div class="menu-container">
        <ul>
          <li>
            <a href="#"><i class="fa-solid fa-table fa-lg"></i>Mensal</a>
          </li>
          <li>
            <a href="./dashDiaria.html"><i class="fa-solid fa-table-columns fa-lg"></i>Diário</a>
          </li>
          <li>
            <a href="./telaFunc.html"><i class="fa-solid fa-users fa-lg"></i>Funcionários</a>
          </li>
          <li>
            <a href="./sensores.html"><i class="fa-solid fa-circle fa-lg"></i>Sensores</a>
          </li>
          <li>
            <a href="https://monarex.atlassian.net/servicedesk/customer/portal/1/group/-1"><i class="fa-solid fa-angles-up"></i>Central de Atendimento</a>
          </li>
          <li id="liSuporte">
          </li>
           <li id="liJira">
          </li>
        </ul>
        </div>
      </div>

      <div class="sair-nav">
        <a onclick="sair()">Sair</a>
        <img src="./docs/exit-icon.png" alt="sair" />
      </div>
    </nav>

    <!--Vazamento-->
    <div class="alerta_caixa" id="alertaCaixa" style="display: none;">
        <button onclick="fecharVazamento()" class="botao_fechar" id="fecharBotao">×</button>

        <div class="alerta_icon">
            <img class="imagem_alerta" src="./docs/imagens-saida.png" alt="alerta de imagem">
        </div>

        <div class="alerta_titulo">
            ALERTA DE VAZAMENTO
        </div>

        <div class="alerta_texto">
            Sensor 01 reportou dados na Câmara 01.
        </div>

        <button class="alerta_botao" id="alertaBotao"><a href="./dashDiaria.html">VER DETALHES <img src="./docs/iconamoon_enter.png" alt="ver detalhes"></a>

    </div>


    <div class="container-dashboard">
      <!--Cabecalho-->
      <div class="cabecalho-mensal">
        <h1>Dashboard <span>Mensal</span></h1>
        <div class="imagem-cabecalho">
          <i class="fa-solid fa-bell"></i>
          <a href="./perf.html"><img src="./docs/fernando-brandao-icon.jpg" alt="" /></a>
        </div>
      </div>

      <!--Status-->
      <section class="elementos-01">       
        
        <div class="container-status-sensor">
      <div class="flex-row-box">
        <img src="./docs/Vector (3).png" alt="">
        <p>Status</p>
      </div>
      <div class="flex-row-box-status" style="background-color: #B30000;">
    <i class="fa-solid fa-triangle-exclamation fa-lg"></i>

        
        <button onclick="vazar()"><p>Critíco</p></button>
      </div>
    </div>

        <!--Selection Mês-->

        <div class="selection-mes">
          <select name="" id="select_mes">
            <option  value="#">Selecione o Mês</option>
            <option value="01">Janeiro</option>
            <option value="02">Fevereiro</option>
            <option value="03">Março</option>
            <option value="04">Abril</option>
            <option value="05">Maio</option>
            <option value="06">Junho</option>
            <option value="07">Julho</option>
            <option value="08">Agosto</option>
            <option value="09">Setembro</option>
            <option value="10">Outubro</option>
            <option value="11">Novembro</option>
            <option selected value="12">Dezembro</option>
            <i class="fa-solid fa-caret-down"></i>
          </select>
          <button id="buttonPesquisar" onclick="pesquisar()">Pesquisar</button>
        </div>
        

        <!-- PPM -->
        <div class="ppm-container">
          <div class="titulo-ppm">
            <i class="fa-solid fa-atom"></i>
            <p>PPM</p>
          </div>
          <div class="card">
            <div class="card-ppm">
              <p><span id="kpiMinimo" class="saida-ppm"></span></p>
              <p>Mínimo</p>
              
            </div>
            <div class="card-ppm">
              <p><span id="kpiMedio" class="saida-ppm"></span></p>
              <p>Média</p>
              
            </div>
            <div class="card-ppm">
              <p><span id="kpiMaximo" class="saida-ppm"></span></p>
              <p>Máximo</p>
              
            </div>
          </div>
        </div>
      </section>

      <section class="elementos-02">
        <div style=" width: 700px;"
          class="chart-container"
          
        >
          <div class="chart-titulo">
            <i class="fa-solid fa-hourglass-half"></i>
            <p>Horários de Picos</p>
          </div>
          <canvas id="chart-incidentes"></canvas>
        </div>
        <div
          class="chart-container"
          
        >
          <div class="chart-titulo">
            <i class="fa-solid fa-hourglass-half"></i>
            <p>PPM Médio</p>
          </div>
          <canvas id="chart-maximo"></canvas>
        </div>
      </section>

      
    </div>



  </body>
</html>


<script>
    // b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
  
    // let proximaAtualizacao;
let graficoPPM;
 idSensor = 1
    if(sessionStorage.SUPORTE == true){

      liSuporte.innerHTML = ` <a href="./bobIA.html"><i class="fa-solid fa-headset"></i>Suporte</a>`
      liJira.innerHTML = `<a href="https://vinimendesdasilvaa.atlassian.net/jira/software/projects/KAN/list"></i>Suporte</a>`      
    }

    window.onload = pesquisar();
    
  function pesquisar(){
    iniciarKpis();
  colocarDadosdePPM();
  criarChartIncidentes(); 
  criarChartSeguranca();
  criarChartHorario();  
  
  }
    function iniciarKpis(){
     
      var mes = select_mes.value;
     
        sessionStorage.MES = mes;

        if(sessionStorage.MES = '#'){
          sessionStorage.MES = 12
        }
      fetch('/kpi/maximo/',{
        method: 'POST',
        headers: {
          'Content-type':'application/json',
        },
        body: JSON.stringify({
          idEmpresaServer: sessionStorage.ID_EMPRESA, 
          mesServer: sessionStorage.MES,
          // idSensorServer: idSensor
        })
      }).then(function(response) {
        console.log('entrei no then do fetch maximo');

        if(response.ok){
            response.json().then((json) => {
              if(json && json.length > 0){
                kpiMaximo.innerHTML = json[0].max_sensor;
                kpiMedio.innerHTML = json[0].media_sensor;
                kpiMinimo.innerHTML = json[0].min_sensor;
                console.log("testea")
              }else{
                kpiMaximo.innerHTML = 'Sem dados'
                kpiMedio.innerHTML = 'Sem dados'
                kpiMinimo.innerHTML = 'Sem dados'
              }
            });
        }
      })

      
  }


  function incidentes(){
    fetch(`/sensores/incidentes/`, {
            method: 'POST',
            headers: {
                'Content-Type': "application/json",
            },
            body: JSON.stringify({
                idEmpresaServer: sessionStorage.ID_EMPRESA,
                idSensorServer: idSensor 
            }),
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then((json) => {
                    if (json && json.length > 0 && json[0].TotalCritico != undefined) {
                        plotarIncidentes(json);
                    }
                })
            }
        });
        
  }


  function dadosMediosPPM() {
    var mes = select_mes.value;

    fetch('/camara/medidas-ppm', {
      method: 'POST',
      headers: {
        'Content-type':'application/json',
      },
      body: JSON.stringify({
        idEmpresaServer: sessionStorage.ID_EMPRESA, 
        mesServer: mes
      })
    })
    .then(response => {
      if (!response.ok) throw new Error("Erro " + response.status);
      return response.json();
    })
    .then(dados => {

      if (dados.length === 0) {
        alert("Nenhum dado encontrado.");
        return;
      }

      const labels2 = dados.map(item => item.momento_grafico);
      const valores2 = dados.map(item => item.sensor_analogico);

      renderizarGraficoPPM2(labels2, valores2);
    })
    .catch(err => console.error("Erro:", err));
  }


   function colocarDadosdePPM() {
    var mes = select_mes.value;





    fetch(`/sensores/incidentes/`, {
            method: 'POST',
            headers: {
                'Content-Type': "application/json",
            },
            body: JSON.stringify({
                idEmpresaServer: sessionStorage.ID_EMPRESA,
                idSensorServer: idSensor 
            }),
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then((json) => {
                    if (json && json.length > 0 && json[0].TotalCritico != undefined) {
                        plotarIncidentes(json);
                    }
                })
            }
        });

    fetch('/camara/medidas-ppm', {
      method: 'POST',
      headers: {
        'Content-type':'application/json',
      },
      body: JSON.stringify({
        idEmpresaServer: sessionStorage.ID_EMPRESA, 
        mesServer: mes
      })
    })
    .then(response => {
      if (!response.ok) throw new Error("Erro " + response.status);
      return response.json();
    })
    .then(dados => {

      if (dados.length === 0) {
        alert("Nenhum dado encontrado.");
        return;
      }

      const labels = dados.map(item => item.momento_grafico);
      const valores = dados.map(item => item.sensor_analogico);

      renderizarGraficoPPM(labels, valores);
    })
    .catch(err => console.error("Erro:", err));
  }


  function renderizarGraficoPPM2(labels2, valores2) {
const cty = document.getElementById('chart-horario').getContext('2d');
    const dataDinamica = {
      labels: labels2,
      datasets: [{
        label: "PPM (Partes por Milhão)",
        data: valores2,
        hoverOffset: 4,
        fill: true,
        borderColor: "#4CAF50",
        backgroundColor: "#4CAF5050",
        pointRadius: 3,
        tension: 0.4,
      }],
    };

    const configDinamica = {
      type: "line",
      data: dataDinamica,
      options: {
        layout: { padding: { bottom: 9 } },
        plugins: {
          annotation: {
            annotations: {
              linhaLimite: {
                type: 'line',
                yMin: 20,
                yMax: 20,
                borderColor: 'red',
                borderWidth: 2
              }
            }
          },
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              font: { size: 11 }
            }
          }
        },
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            min: 0,
            max: 30,
            ticks: { font: { size: 7 } },
          },
          x: {
            ticks: { font: { size: 7 } },
          },
        },
      },
    };

    if (graficoPPM2) {
      graficoPPM2.data.labels = labels2;
      graficoPPM2.data.datasets[0].data = valores2;
      graficoPPM2.update();
    } else {
      graficoPPM2 = new Chart(cty, configDinamica);
    }
  }


  function plotarIncidentes(json) {
        
        if (!json || json.length === 0) {
            console.warn("Nenhuma resposta de dados para plotar incidentes.");
            return;
        }
        const totais = json[0];

        const dadosCritico = [totais.TotalCritico];
        const dadosAlerta = [totais.TotalAlerta];
        const dadosNormal = [totais.TotalNormal];

        const labelsEixoX = ['Contagem Total de Incidentes'];

        const cti = document.getElementById("chart-incidentes");

        new Chart(cti, {
            type: "bar",
            data: {
                labels: labelsEixoX,
                datasets: [
                    {
                        label: "Crítico",
                        data: dadosCritico,
                        borderWidth: 1,
                        backgroundColor: '#e30000',
                        borderColor: '#e30000',
                        borderRadius: 5,
                    },
                    {
                        label: "Alerta",
                        data: dadosAlerta,
                        borderWidth: 1,
                        backgroundColor: '#cb980b',
                        borderColor: '#cb980b',
                        borderRadius: 5,
                    },
                    {
                        label: "Normal",
                        data: dadosNormal,
                        borderWidth: 1,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 0.8)',
                        borderRadius: 5,
                    }

                ],
            },
            options: {
                layout: {
                    padding: {
                        bottom: 9
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 10,
                        ticks: {
                            font: {
                                size: 10
                            }
                        },
                    },

                    x: {
                        ticks: {
                            font: {
                                size: 10
                            }
                        },
                    },
                },
            },
        });
    }


 function renderizarGraficoPPM(labels, valores) {
const ctx = document.getElementById('chart-maximo').getContext('2d');
    const dataDinamica = {
      labels: labels,
      datasets: [{
        label: "PPM (Partes por Milhão)",
        data: valores,
        hoverOffset: 4,
        fill: true,
        borderColor: "#4CAF50",
        backgroundColor: "#4CAF5050",
        pointRadius: 3,
        tension: 0.4,
      }],
    };

    const configDinamica = {
      type: "line",
      data: dataDinamica,
      options: {
        layout: { padding: { bottom: 9 } },
        plugins: {
          annotation: {
            annotations: {
              linhaLimite: {
                type: 'line',
                yMin: 20,
                yMax: 20,
                borderColor: 'red',
                borderWidth: 2
              }
            }
          },
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              font: { size: 11 }
            }
          }
        },
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            min: 0,
            max: 30,
            ticks: { font: { size: 7 } },
          },
          x: {
            ticks: { font: { size: 7 } },
          },
        },
      },
    };

    if (graficoPPM) {
      graficoPPM.data.labels = labels;
      graficoPPM.data.datasets[0].data = valores;
      graficoPPM.update();
    } else {
      graficoPPM = new Chart(ctx, configDinamica);
    }
  }

  function sair(){
          
          sessionStorage.clear();
          window.location.href ='../index.html'
        }


</script>