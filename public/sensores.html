<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./styles/style.css" />
    <script src="https://kit.fontawesome.com/eebdb6e4f5.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Document</title>
</head>

<body class="Dashboard">
    <nav class="menu-nav">
        <div class="logo-nav-lateral">
            <a href="#"><img src="./docs/Logo-Monarex.png" alt="logo" /></a>
            <div class="menu-container">
                <ul>
                    <li>
                        <a href="./dashMes.html"><i class="fa-solid fa-table fa-lg"></i>Mensal</a>
                    </li>
                    <li>
                        <a href="./dashDiaria.html"><i class="fa-solid fa-table-columns fa-lg"></i>Diário</a>
                    </li>
                    <li>
                        <a href="./telaFunc.html"><i class="fa-solid fa-users fa-lg"></i>Funcionários</a>
                    </li>
                    <li>
                        <a href="#"><i class="fa-solid fa-circle fa-lg"></i>Sensores</a>
                    </li>
                    <li>
                        <a href="https://monarex.atlassian.net/servicedesk/customer/portal/1/group/-1"><i class="fa-solid fa-angles-up"></i>Central de Atendimento</a>
                    </li>
                    <li id="liSuporte">
                    </li>
                </ul>
            </div>
        </div>

        <div class="sair-nav">
           <a onclick="sair()">Sair</a>
            <img src="./docs/exit-icon.png" alt="sair" />
        </div>
    </nav>

    <div class="container-dashboard">
        <div class="cabecalho-mensal">
            <h1>Sensores</h1>
            <div class="imagem-cabecalho">
                <i class="fa-solid fa-bell"></i>
      <a href="./perf.html"><img src="./docs/25634.png" alt="" /></a>
            </div>
        </div>

        <section class="elementos-01">
            <div class="status">
                <div class="texto-status">
                    <div class="icone-status">
                        <i class="fa fa-refresh fa-2xs"></i>
                    </div>
                    <div class="titulo-status">
                        <p>Status</p>
                    </div>
                </div>
                <div class="saida-status">
                    <div class="icone-saida">
                        <i class="fa-solid fa-triangle-exclamation fa-xs"></i>
                    </div>
                    <div class="titulo-saida">
                        <p>Critíco</p>
                    </div>
                </div>
            </div>

            <div class="container-camara">
                <div class="camara-text-sensor">
                    <p> Selecione a Câmara </p>
                    <p> Período </p>
                    <p> Sensor </p>
                </div>

                <div class="container-camara-selects-sensor">
                    <select name="#" id="selectCamara" class="camara-select">
                        <option value="" disabled> Selecione </option>
                        <option value="1" selected> Câmara 01</option>
                    </select>

                    <select name="#" id="selectTempo" class="temp-select">
                        <option value="" disabled selected> Selecione </option>
                        <option value="24h">Últimas 24 horas</option>
                        <option value="7d">Últimos 7 dias</option>
                        <option value="30d">Últimos 30 dias</option>
                        <option value="mes-atual">Mês Atual</option>
                        <option value="mes-anterior">Mês Anterior</option>
                        <option value="ano-atual">Ano Atual</option>
                        <option value="ano-anterior">Ano Anterior</option>
                    </select>

                    <select name="#" id="sensor_select" class="sensor-select">
                        <option value="" disabled selected> Selecione </option>
                        <option value="1">Sensor 01</option>
                        <option value="2">Sensor 02</option>
                        <option value="3">Sensor 03</option>
                        <option value="4">Sensor 04</option>
                        <option value="5">Sensor 05</option>
                        <option value="6">Sensor 06</option>
                        <option value="7">Sensor 07</option>
                        <option value="8">Sensor 08</option>
                        <option value="9">Sensor 09</option>
                        <option value="10">Sensor 10</option>
                        <option value="11">Sensor 11</option>
                        <option value="12">Sensor 12</option>
                        <option value="13">Sensor 13</option>
                        <option value="14">Sensor 14</option>
                        <option value="15">Sensor 15</option>
                    </select>
                </div>
            </div>

            <div class="ppm-container">
                <div class="titulo-ppm">
                    <i class="fa-solid fa-atom"></i>
                    <p>Visão Geral dos Sensores</p>
                </div>
                <div class="card">
                    <div class="card-ppm">
                        <p><span id="ativos" class="saida-ppm"></span></p>
                        <p> Ativos</p>

                    </div>
                    <div class="card-ppm">
                        <p><span id="inativos" class="saida-ppm"></span></p>
                        <p> Inativos</p>

                    </div>
                    <div class="card-ppm">
                        <p><span id="emAlerta" class="saida-ppm"></span></p>
                        <p>Em Alerta</p>

                    </div>
                </div>
            </div>
        </section>


        <div class="container-elementos-sensores">
            <div class="container-elementos-grafico">
                <section class="elementos-02-sensor">
                    <div class="chart-container">
                        <div class="chart-titulo">
                            <i class="fa-solid fa-hourglass-half"></i>
                            <p>Horários de Picos</p>
                        </div>
                        <canvas id="chart-horario"></canvas>
                    </div>
                </section>

                <section class="elementos-03-sensor">
                    <div class="chart-container">
                        <div class="chart-titulo">
                            <i class="fa-solid fa-chart-simple"></i>
                            <p>Incidentes</p>
                        </div>
                        <canvas id="chart-incidentes"></canvas>
                    </div>
                </section>
            </div>

            <div class="container-table-sensor">
                <div class="flex-row-box-sensor">
                    <p> Histórico </p>
                </div>
                <<table class="tabela-funcionarios">
      <thead>
        <tr>
          <th>PPM</th>
          <th>Sensor ID</th> 
          <th>Câmara ID</th> 
          <th>Tempo de Leitura</th>
          <th>Atividade</th>
          <th>Classificação</th>
        </tr>
      </thead>
      <tbody id="historicoSensorBody"> 
        <tr>
          <td colspan="4">Carregando histórico...</td>
        </tr>
      </tbody>
    </table>
            </div>
        </div>
</body>

</html>
<script>
    var graficoPPM;
    var proximaAtualizacaoPPM;
    var proximaAtualizacaoKPI;
    
    // Variável para a referência do elemento do gráfico de Horário (será definida em iniciarKpis)
    var cth_ref; 
    
    window.onload = iniciarKpis;

    function iniciarKpis() {
        
        // 1. Inicializa as referências DOM (AGORA SEGURO, DENTRO DO window.onload)
        const cth = document.getElementById("chart-horario");
        cth_ref = cth; // Armazena a referência globalmente
        const selectSensor = document.getElementById("sensor_select");
        const selectTempo = document.getElementById("selectTempo");
        const selectCamara = document.getElementById("selectCamara");


        // 2. Lógica do Suporte (Permissão)
        const permisaoSuporte = sessionStorage.getItem('SUPORTE');
        const liSuporte = document.getElementById('liSuporte');
        if (permisaoSuporte === 'true') {
            liSuporte.innerHTML = `<a href="./bobIA.html"><i class="fa-solid fa-headset"></i>Suporte</a>`;
        }

        // 3. Definir IDs Padrão (usa 1 se não houver valor ou for um placeholder)
        const idCamaraPadrao = selectCamara ? (selectCamara.value || '1') : '1';
        const idSensor = selectSensor ? (selectSensor.value || '1') : '1'; 


        // 4. Inicializa o gráfico de Picos (PPM) e Inicia a busca de dados
        renderizarGraficoPPM([], [], cth_ref); 
        // Passa as referências como parâmetros para que as funções de loop e listener possam usá-las
        buscarDadosPPM(idCamaraPadrao, selectSensor, selectTempo); 
        historicoSensor();

        // 5. KPI Sensores Ativos/Inativos
        fetch('/sensores/sens', {
            method: 'POST',
            headers: {
                'Content-type': 'application/json',
            },
            body: JSON.stringify({
                idEmpresaServer: sessionStorage.ID_EMPRESA
            })
        }).then(function (response) {
            if (response.ok) {
                response.json().then((json) => {
                    if (json && json.length > 0 && json[0].ativos != undefined) {
                        ativos.innerHTML = json[0].ativos
                        inativos.innerHTML = json[0].inativos
                        emAlerta.innerHTML = json[0].emAlertas

                        if (json[0].emAlertas == 0) {
                            emAlerta.innerHTML = 'Nenhum'
                        }
                    } else {
                        ativos.innerHTML = 'Sem dados'
                        inativos.innerHTML = 'Sem dados'
                        emAlerta.innerHTML = 'Sem dados'
                    }
                });
            }
        });


        // 6. Gráfico de Incidentes
        fetch(`/sensores/incidentes/`, {
            method: 'POST',
            headers: {
                'Content-Type': "application/json",
            },
            body: JSON.stringify({
                idEmpresaServer: sessionStorage.ID_EMPRESA,
                idSensorServer: idSensor 
            }),
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then((json) => {
                    if (json && json.length > 0 && json[0].TotalCritico != undefined) {
                        plotarIncidentes(json);
                    }
                })
            }
        });
        
        // 7. NOVO: Adiciona a interatividade dos filtros
        adicionarListenersDeFiltro(selectCamara, selectSensor, selectTempo);
    }

    // NOVA FUNÇÃO: Adiciona os event listeners aos selects
    function adicionarListenersDeFiltro(selectCamara, selectSensor, selectTempo) {
        
        // Listener para o Período
        if (selectTempo) {
            selectTempo.addEventListener('change', function() {
                const idCamaraAtual = selectCamara ? (selectCamara.value || '1') : '1';
                // Reinicia a busca de dados com os novos filtros
                buscarDadosPPM(idCamaraAtual, selectSensor, selectTempo);
            });
        }
        
        // Listener para a Câmara
        if (selectCamara) {
            selectCamara.addEventListener('change', function() {
                const idCamaraAtual = selectCamara.value;
                // Reinicia a busca de dados com os novos filtros
                buscarDadosPPM(idCamaraAtual, selectSensor, selectTempo);
            });
        }
        
        // Listener para o Sensor
        if (selectSensor) {
            selectSensor.addEventListener('change', function() {
                const idCamaraAtual = selectCamara ? (selectCamara.value || '1') : '1';
                // Reinicia a busca de dados de PPM com o novo Sensor
                buscarDadosPPM(idCamaraAtual, selectSensor, selectTempo);
                
                // Opcional: Recarrega Incidentes se o sensor mudar
                // Se o gráfico de incidentes depende do sensor, você precisa chamar o fetch novamente aqui
                // fetchIncidentes(idCamaraAtual, selectSensor.value); // Função a ser criada ou integrada
            });
        }
    }


    function buscarDadosPPM(idCamara, selectSensor, selectTempo) {
        if (proximaAtualizacaoPPM != undefined) {
            clearTimeout(proximaAtualizacaoPPM);
        }

        // Obtendo os valores dos selects (com fallback seguro)
        // Usa o valor selecionado OU o valor '1'/'24h' como padrão
        const idSensor = selectSensor ? (selectSensor.value !== '' && selectSensor.value !== 'Selecione' ? selectSensor.value : '1') : '1';
        const periodo = selectTempo ? (selectTempo.value !== '' && selectTempo.value !== 'Selecione' ? selectTempo.value : '24h') : '24h';
        
        const endpoint = `/camara/medidas-ppm/${idCamara}?idSensor=${idSensor}&periodo=${periodo}`;
        
        fetch(endpoint)
            .then(response => {
                if (!response.ok) {
                    console.error('Falha na API de PPM. Status: ', response.status);
                    throw new Error('Falha ao buscar dados do PPM.');
                }
                return response.status !== 204 ? response.json() : [];
            })
            .then(dadosMedicao => {
                const labels = [];
                const valores = [];

                for (let i = 0; i < dadosMedicao.length; i++) {
                    const item = dadosMedicao[i];
                    labels.push(item.momento_grafico);
                    valores.push(item.sensor_analogico);
                }

                renderizarGraficoPPM(labels, valores, cth_ref); // Usa a referência global do canvas

                // Repetição da busca (Loop)
                proximaAtualizacaoPPM = setTimeout(() => buscarDadosPPM(idCamara, selectSensor, selectTempo), 5000);
            })
            .catch(error => {
                console.error('Erro ao buscar dados de PPM:', error);
                // Repetição da busca mesmo em caso de erro
                proximaAtualizacaoPPM = setTimeout(() => buscarDadosPPM(idCamara, selectSensor, selectTempo), 5000);
            });
    }

    // A função renderizarGraficoPPM agora usa cth_ref, definida em iniciarKpis
    function renderizarGraficoPPM(labels, valores) {

        const dataDinamica = {
            labels: labels,
            datasets: [{
                label: "PPM (Partes por Milhão)",
                data: valores,
                hoverOffset: 4,
                fill: true,
                borderColor: "#4CAF50",
                backgroundColor: "#4CAF5050",
                pointRadius: 3,
                tension: 0.4,
            }],
        };

        const configDinamica = {
            type: "line",
            data: dataDinamica,
            options: {
                layout: {
                    padding: {
                        bottom: 9
                    }
                },
                plugins: {
                    annotation: {
                        annotations: {
                            linhaLimite: {
                                type: 'line',
                                yMin: 20,
                                yMax: 20,
                                borderColor: 'red',
                                borderWidth: 2
                            }
                        }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 30,
                        ticks: {
                            font: {
                                size: 7
                            }
                        },
                    },
                    x: {
                        ticks: {
                            font: {
                                size: 7
                            }
                        },
                    },
                },
            },
        };

        if (graficoPPM) {
            graficoPPM.data.labels = labels;
            graficoPPM.data.datasets[0].data = valores;
            graficoPPM.update();
        } else {
            // Usa a referência global para o elemento canvas
            if (cth_ref) {
                 graficoPPM = new Chart(cth_ref, configDinamica);
            }
        }
    }

    function historicoSensor() {
    fetch('/sensores/historico-sensor/', {
        method: 'POST',
        headers: {
            'Content-type': 'application/json',
        },
        body: JSON.stringify({
            idEmpresaServer: sessionStorage.ID_EMPRESA
        })
    }).then(function (response) {
        console.log('Entrei no fetch de Histórico do Sensor'); 
        if (response.ok) {

            var tbody = document.getElementById("historicoSensorBody"); 
            tbody.innerHTML = "";

            response.json().then(function (leituras) {
                if (leituras.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">Nenhuma leitura encontrada.</td></tr>';
                    return;
                }
                for (let i = 0; i < leituras.length; i++) {
                    var leitura = leituras[i];
                    var tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td> ${leitura.ppm} </td> 
                        <td> ${leitura.id_sensor} </td>
                        <td> ${leitura.numero_camara} </td>
                        <td> ${leitura.tempo_leitura} </td>
                        <td>${leitura.Atividade}</td>
                        <td>${leitura.classificacao}</td>
                    `;

                    tbody.appendChild(tr);
                }
            });
        } else {
             var tbody = document.getElementById("historicoSensorBody");
             tbody.innerHTML = '<tr><td colspan="4">Erro ao carregar o histórico.</td></tr>';
        }
    })
}
function verificarStatus(valorMaximo) { // Renomeei para maior clareza
    if (valorMaximo >= 15) {
      statusCor.style.backgroundColor = "#B30000";
      return `CRITICO`; // Deve retornar apenas a string

    } else if (valorMaximo >= 10) {
      statusCor.style.backgroundColor = "#ffaa00";
      return `ALERTA`; // Deve retornar apenas a string
    } else {
      fecharVazamento();
      statusCor.style.backgroundColor = "#003d02";
      return `NORMAL`; // Deve retornar apenas a string
    }
  }

    function plotarIncidentes(json) {
        
        if (!json || json.length === 0) {
            console.warn("Nenhuma resposta de dados para plotar incidentes.");
            return;
        }
        const totais = json[0];

        const dadosCritico = [totais.TotalCritico];
        const dadosAlerta = [totais.TotalAlerta];
        const dadosNormal = [totais.TotalNormal];

        const labelsEixoX = ['Contagem Total de Incidentes'];

        const cti = document.getElementById("chart-incidentes");

        new Chart(cti, {
            type: "bar",
            data: {
                labels: labelsEixoX,
                datasets: [
                    {
                        label: "Crítico",
                        data: dadosCritico,
                        borderWidth: 1,
                        backgroundColor: '#e30000',
                        borderColor: '#e30000',
                        borderRadius: 5,
                    },
                    {
                        label: "Alerta",
                        data: dadosAlerta,
                        borderWidth: 1,
                        backgroundColor: '#cb980b',
                        borderColor: '#cb980b',
                        borderRadius: 5,
                    },
                    {
                        label: "Normal",
                        data: dadosNormal,
                        borderWidth: 1,
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 0.8)',
                        borderRadius: 5,
                    }

                ],
            },
            options: {
                layout: {
                    padding: {
                        bottom: 9
                    }
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: {
                                size: 11
                            }
                        }
                    }
                },
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: 0,
                        max: 10,
                        ticks: {
                            font: {
                                size: 10
                            }
                        },
                    },

                    x: {
                        ticks: {
                            font: {
                                size: 10
                            }
                        },
                    },
                },
            },
        });
    }


    function sair(){
          
          sessionStorage.clear();
          window.location.href ='../index.html'
        }

</script>